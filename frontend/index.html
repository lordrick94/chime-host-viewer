<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>CHIME FRB Host Viewer</title>

    <!-- Main styles -->
    <link rel="stylesheet" href="style.css" />

    <!-- NEW: Plotly for interactive plots -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  </head>
  <body>
    <div id="app">
      <!-- Sidebar: filters, status, table -->
      <aside id="sidebar">
        <header id="sidebar-header">
          <h1>FRB Viewer</h1>
          <div id="data-source-selector">
            <label for="data-source-select">Data Source:</label>
            <select id="data-source-select" disabled>
              <option value="">Loading...</option>
            </select>
            <span id="switch-status"></span>
          </div>
          <div id="status">Loading…</div>
        </header>

        <section id="controls">
          <h2>Filters</h2>
          <div class="control-group">
            <label for="filter-frb-id">
              FRB ID contains:
              <input
                type="text"
                id="filter-frb-id"
                placeholder="e.g. 2020, 2019, A, B"
              />
            </label>
          </div>

          <div class="control-group">
            <label for="filter-min-top1">
              Min top1 P_Ox:
              <input
                type="number"
                step="0.001"
                id="filter-min-top1"
                placeholder="e.g. 0.5"
              />
            </label>
          </div>

          <div class="control-group">
            <label for="filter-min-sum">
              Min sum top2 P_Ox:
              <input
                type="number"
                step="0.001"
                id="filter-min-sum"
                placeholder="e.g. 0.8"
              />
            </label>
          </div>

          <div class="control-group">
            <button id="clear-selection">Clear selection</button>
          </div>

          <!-- NEW: grid view dropdowns (PATH / HOST) -->
          <section id="grid-controls">
            <h2>Grid Views</h2>

            <div class="dropdown-group">
              <span class="dropdown-label">CHIME-PATH</span>
              <div id="dropdown-path" class="dropdown">
                <a href="#" data-mode="path-main">Main PATH images</a>
                <a href="#" data-mode="path-zoomin">Zoom-in PATH images</a>
                <a href="#" data-mode="path-local-stars">Local (with stars)</a>
                <a href="#" data-mode="path-local-nostars">Local (no stars)</a>
              </div>
            </div>

            <div class="dropdown-group">
              <span class="dropdown-label">CHIME-HOST</span>
              <div id="dropdown-host" class="dropdown">
                <a href="#" data-mode="host-all">All HOST images</a>
                <a href="#" data-mode="host-ppxf">pPXF fits</a>
                <a href="#" data-mode="host-sed">SEDs</a>
                <a href="#" data-mode="host-spectra">Spectra</a>
              </div>
            </div>
          </section>
        </section>

        <section id="frb-table-section">
          <h2>FRBs</h2>
          <div class="table-wrapper">
            <table id="frb-table">
              <thead>
                <tr>
                  <th>FRB</th>
                  <th>Year</th>
                  <th>Top1 P_Ox</th>
                  <th>Sum top2 P_Ox</th>
                </tr>
              </thead>
              <tbody id="frb-table-body">
                <!-- filled by viewer.js -->
              </tbody>
            </table>
          </div>
        </section>
      </aside>

      <!-- Main panel: details/images + NEW Data & Plots tab -->
      <main id="main-panel">
        <!-- NEW: tab buttons -->
        <div id="main-tabs">
          <button id="tab-details" class="tab-button active">
            Details &amp; Images
          </button>
          <button id="tab-data" class="tab-button">
            Data &amp; Plots
          </button>
        </div>

        <!-- DETAILS TAB PANEL (existing behavior) -->
        <section id="panel-details" class="tab-panel">
          <h2 id="selected-title">No FRB selected</h2>
          <div id="selected-info">
            Use the filters and table on the left to pick an FRB.
          </div>

          <!-- Big images / grid used by existing viewer.js -->
          <div id="images-container">
            Select an FRB in the table on the left.
          </div>
        </section>

        <!-- NEW: DATA & PLOTS TAB PANEL -->
        <section
          id="panel-data"
          class="tab-panel hidden"
        >
          <h2>PATH Candidate Data &amp; Plots</h2>

          <!-- NEW: Plot controls -->
          <div id="plot-controls">
            <div class="controls-row">
              <label>
                X-axis:
                <select id="plot-x-column"></select>
              </label>
              <label>
                Y-axis:
                <select id="plot-y-column"></select>
              </label>
            </div>

            <div class="controls-row">
              <label>
                Min P_Ox:
                <input
                  type="number"
                  step="0.001"
                  id="cut-min-pox"
                  placeholder="e.g. 0.1"
                />
              </label>
              <label>
                Max P_Ox:
                <input
                  type="number"
                  step="0.001"
                  id="cut-max-pox"
                  placeholder="e.g. 0.99"
                />
              </label>
              <label>
                Max mag:
                <input
                  type="number"
                  step="0.1"
                  id="cut-max-mag"
                  placeholder="e.g. 25"
                />
              </label>
            </div>

            <div class="controls-row">
              <label>
                Candidates to load:
                <select id="candidates-mode-select">
                  <option value="top1" selected>Top 1 per FRB</option>
                  <option value="top2">Top 2 per FRB</option>
                  <option value="top5">Top 5 per FRB</option>
                  <option value="all">All candidates</option>
                </select>
              </label>
            </div>
            <div class="controls-row">
              <button id="btn-apply-cuts">Apply cuts</button>
              <button id="btn-generate-plot">Generate plot</button>
              <button id="btn-load-all" class="btn-load-all" title="Load candidates for plotting">Load data for plot</button>
            </div>
            <div id="data-load-status" class="data-load-status"></div>
          </div>

          <!-- NEW: Plot container -->
          <div id="path-plot" style="height: 400px; margin-top: 1rem;">
            <!-- Plotly will render here -->
          </div>

          <!-- NEW: Candidate table -->
          <h3 style="margin-top: 1.5rem;">
            PATH Candidate Table (after cuts)
          </h3>
          <!-- Pagination controls -->
          <div id="pagination-controls" class="pagination">
            <div id="pagination-info">Showing 0 of 0 candidates</div>
            <div class="pagination-buttons">
              <button id="btn-prev-page" disabled>← Previous</button>
              <span id="page-indicator">Page 1</span>
              <button id="btn-next-page" disabled>Next →</button>
            </div>
            <div class="pagination-size">
              <label>
                Per page:
                <select id="page-size-select">
                  <option value="50">50</option>
                  <option value="100" selected>100</option>
                  <option value="500">500</option>
                  <option value="1000">1000</option>
                </select>
              </label>
            </div>
          </div>
          <div class="table-wrapper">
            <table id="path-data-table">
              <thead>
                <tr>
                  <th>FRB</th>
                  <th>Cand ID</th>
                  <th>mag</th>
                  <th>P_Ox</th>
                  <th>P_O</th>
                  <th>P_XO</th>
                  <th>Survey</th>
                  <th>z_phot</th>
                  <th>z_spec</th>
                </tr>
              </thead>
              <tbody id="path-data-tbody">
                <!-- filled by viewer.js -->
              </tbody>
            </table>
          </div>
        </section>
      </main>
    </div>

    <!-- Lightbox modal -->
    <div id="lightbox" class="lightbox hidden">
      <div class="lightbox-overlay"></div>
      <div class="lightbox-content">
        <button id="lightbox-close" class="lightbox-close" title="Close (Esc)">&times;</button>
        <button id="lightbox-prev" class="lightbox-nav lightbox-prev" title="Previous (←)">&#10094;</button>
        <div class="lightbox-image-container">
          <img id="lightbox-img" src="" alt="Full size image" />
          <div id="lightbox-caption" class="lightbox-caption"></div>
        </div>
        <button id="lightbox-next" class="lightbox-nav lightbox-next" title="Next (→)">&#10095;</button>
      </div>
      <div class="lightbox-toolbar">
        <button id="lightbox-download" class="lightbox-download" title="Download image">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Download
        </button>
        <span class="lightbox-counter">
          <span id="lightbox-current">1</span> / <span id="lightbox-total">1</span>
        </span>
      </div>
    </div>

    <!-- Main viewer logic -->
    <script src="viewer.js"></script>
  </body>
</html>
